<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Popup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #end-chat-button {
            color: white;
            background-color: red;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin: 10px;
            border-radius: 5px;
        }

        #chatbot-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            text-align: center;
            line-height: 60px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        #chatbot-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 999;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: scale(0);
            opacity: 0;
        }

        #chatbot-container.visible {
            transform: scale(1);
            opacity: 1;
        }

        #chatbot-header {
            background-color: #007bff;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        #chatbot-messages {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #f1f1f1;
        }

        #chatbot-messages div {
            margin: 10px 0;
            display: flex;
        }

        .chat-message {
            max-width: 70%;
            padding: 10px;
            border-radius: 10px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        #chatbot-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            padding: 10px;
            background-color: #f9f9f9;
        }

        #chatbot-options button {
            padding: 4px;
            background-color: white;
            color: red;
            border: 1px solid red; 
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            display: block; 
        }

        #chatbot-input {
            display: flex;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #ccc;
        }

        #chatbot-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            outline: none; /* Asegura que no se vea un borde de enfoque no deseado */
            box-sizing: border-box; /* Hace que el padding se incluya en el tama√±o total del input */
            width: 100%; /* Asegura que el input ocupe todo el ancho disponible */
            cursor: text; /* Muestra el cursor de texto para que sea m√°s evidente que es un campo de entrada */
        }


        #chatbot-input button {
            margin-left: 10px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f1f1f1;
        }

        .typing-indicator span {
            height: 10px;
            width: 10px;
            float: left;
            margin: 0 1px;
            background-color: #9E9EA1;
            display: block;
            border-radius: 50%;
            opacity: 0.4;
        }

        .typing-indicator span:nth-of-type(1) {
            animation: 1s blink infinite 0.3333s;
        }

        .typing-indicator span:nth-of-type(2) {
            animation: 1s blink infinite 0.6666s;
        }

        .typing-indicator span:nth-of-type(3) {
            animation: 1s blink infinite 0.9999s;
        }

        @keyframes blink {
            50% {
                opacity: 1;
            }
        }

        /* Estilos para el mensaje emergente */
        #toast-message {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1001;
        }

        #toast-message.show {
            opacity: 1;
        }
        .product-results {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            padding: 10px;
        }

        .product-results p {
            margin: 5px 0;
        }

        .user-message {
            background-color: #ed9e98; /* Color de fondo para el usuario */
            align-self: flex-end; /* Alinea a la derecha */
            border-bottom-right-radius: 0;
            margin-left: auto; /* Asegura que el mensaje se alinee a la derecha */
        }


        .chatbot-message {
            background-color: white; /* Fondo del chatbot */
            align-self: flex-start; /* Alinea a la izquierda */
            border-bottom-left-radius: 0;
        }

    </style>
</head>
<body>
    <div id="chatbot-button" onclick="toggleChat()">üí¨</div>

    <div id="chatbot-container">
        <div id="chatbot-header">
            Chatbot S21
        </div>
        <div id="chatbot-messages">
            
        </div>
       
        <div id="chatbot-options">
            <button onclick="sendOption('Horario')">Horario</button>
            <button onclick="sendOption('Ubicaci√≥n')">Ubicaci√≥n</button>
            <button onclick="sendOption('Contacto')">Contacto</button>
            <button onclick="sendOption('Ser Cliente')">Ser Cliente</button>
            <button onclick="sendOption('Pol√≠ticas')">Pol√≠ticas</button>
        </div>
        <button id="end-chat-button" onclick="endChat()">
            END CHAT
        </button>

        <div id="chatbot-input" onclick="focusInput()">
            <input type="text" id="user-message" placeholder="Escribe un mensaje..." onkeydown="handleKey(event)">
            <button id="send-button" onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <!-- Mensaje emergente -->
    <div id="toast-message">Hola, puedo responder todas las dudas que tengas.</div>

    <script>
        let isWaitingForResponse = false;
        let toastTimeout;

        function toggleChat() {
            const chatbotContainer = document.getElementById('chatbot-container');
            const messageInput = document.getElementById('user-message');
            
            chatbotContainer.classList.toggle('visible');

            if (chatbotContainer.classList.contains('visible')) {
                messageInput.focus();
                hideToast();
            } else {
                showToast();
            }
        }

        function showToast() {
            const toast = document.getElementById('toast-message');
            toast.classList.add('show');
            
            // Limpiar cualquier timeout existente
            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }
            
            // Configurar un nuevo timeout para ocultar el toast despu√©s de 6 segundos
            toastTimeout = setTimeout(() => {
                hideToast();
            }, 6000);
        }

        function hideToast() {
            const toast = document.getElementById('toast-message');
            toast.classList.remove('show');
            
            // Limpiar el timeout si existe
            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }
        }
        function focusInput() {
    document.getElementById('user-message').focus();
}


        function sendMessage() {
            if (isWaitingForResponse) return;

            const messageInput = document.getElementById('user-message');
            const message = messageInput.value.trim();
            const messagesContainer = document.getElementById('chatbot-messages');
            const sendButton = document.getElementById('send-button');
            
            if (message === '') return;

            messageInput.disabled = true;
            sendButton.disabled = true;
            isWaitingForResponse = true;

            addMessage('T√∫', message);
            saveMessage('T√∫', message);

            showTypingIndicator();

            fetch('/chatbot/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: 'message=' + message
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();

                addMessage('Chatbot', data.reply);
                saveMessage('Chatbot', data.reply);

                messageInput.disabled = false;
                sendButton.disabled = false;
                isWaitingForResponse = false;
                messageInput.value = '';
                messageInput.focus();
            });
        }

        function sendOption(option) {
            document.getElementById('user-message').value = option;
            sendMessage();
        }

        function handleKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(sender, text) {
    const messagesContainer = document.getElementById('chatbot-messages');
    const messageElement = document.createElement('div');

    // Crear la burbuja del mensaje
    const messageBubble = document.createElement('div');
    messageBubble.classList.add('chat-message');

    // Diferenciar entre mensajes del usuario y del chatbot
    if (sender === 'T√∫') {
        messageBubble.classList.add('user-message');
        messageBubble.textContent = text; // El usuario sigue enviando texto plano
    } else {
        messageBubble.classList.add('chatbot-message');
        messageBubble.innerHTML = text; // El chatbot puede enviar HTML
    }

    messageElement.appendChild(messageBubble);
    messagesContainer.appendChild(messageElement);

    // Desplazar hacia abajo para mostrar el √∫ltimo mensaje
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

    function saveMessage(sender, text) {
        const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        chatHistory.push({ sender, text });
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    }

        function loadChatHistory() {
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];

            if (chatHistory.length === 0) {
                addMessage('Chatbot', 'Hola, te responder√© todas las dudas correspondientes');
            } else {
                chatHistory.forEach(message => {
                    addMessage(message.sender, message.text);
                });
            }
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatbot-messages');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const messagesContainer = document.getElementById('chatbot-messages');
            const typingIndicator = messagesContainer.querySelector('.typing-indicator');
            if (typingIndicator) {
                messagesContainer.removeChild(typingIndicator);
            }
        }

        window.onload = function() {
            loadChatHistory();
            showToast(); // Mostrar el mensaje emergente al cargar la p√°gina
        };
    
        function endChat() {
            document.getElementById('chatbot-messages').innerHTML = '';
            document.getElementById('user-message').value = '';
            document.getElementById('chatbot-container').classList.remove('visible');
        }
    </script>
</body>
</html>